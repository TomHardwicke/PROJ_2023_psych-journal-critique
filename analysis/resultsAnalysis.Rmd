---
title: "Results Analysis"
author: "Annie Whamond"
date: "2024-04-10"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages

```{r}
# Load libraries
library(here)
library(lsr)
library(dplyr)
library(tidyverse)
library(tidylog)
library(binom)
library(ggplot2)
library(RColorBrewer)
library(assertthat) 
```

# Load data

```{r}
# Load preprocessed data
d_articles <- read_csv(here('data', 'processed', 'd_articles.csv'), show_col_types = F) # article data 
d_journals <- read_csv(here('data', 'processed', 'd_journals.csv'), show_col_types = F) # journal data
```

*Note.* PPC = post-publication critique

# STUDY ONE: JOURNAL POLICY

Remove excluded journals and create separate tibbles for prominent and randomly selected journals
```{r}
dj_prominent <- d_journals %>%
  filter(sample_id != "random") %>%
  filter(is_empirical == TRUE)

dj_random <- d_journals %>%
  filter(sample_id != "prominent") %>%
  filter(is_empirical == TRUE)
```
```{r}
# Run a test to ensure all randomly-selected and non-empirical journals removed from dj_prominent
assert_that(
  all(dj_prominent$sample_id == "prominent" | dj_prominent$sample_id == "both" 
      & dj_prominent$is_empirical == TRUE),
  msg = "Found unexpected values in the sample_id or is_empirical columns"
  )

# Run a test to ensure all prominent sample and non-empirical journals removed from dj_random
assert_that(
  all(dj_random$sample_id == "random" | 
        dj_random$sample_id == "both" 
      & dj_random$is_empirical == TRUE),
  msg = "Found unexpected values in the sample_id or is_empirical columns"
  )

```

## Journal characteristics
Descriptive statistics 

Calculate JIF median and IQR for prominent journals
```{r}
# Prominent journal sample
prominentJIF <- dj_prominent %>% 
  filter(ppc_type == "A") %>%      # Keep only single entry for each journal
  summarise(promMedian_jif = round(median(jif),2), 
            promMin_jif = round(min(jif),2),
            promMax_jif = round(max(jif),2),
            promIQR_jif = round(IQR(jif),2)
  )

prominentJIF
```

Calculate JIF median and IQR for random journals
```{r}
randomJIF <- dj_random %>% 
  filter(ppc_type == "A") %>%
  filter(!is.na(jif)) %>%
  summarise(randMedian_jif = round(median(jif),2),
            randMin_jif = round(min(jif),2),
            randMax_jif = round(max(jif),2),
            randIQR_jif = round(IQR(jif),2)
  )

randomJIF
```

Count prominent journals listed as COPE members 
```{r}
prominentCOPE <- dj_prominent %>%
  filter(ppc_type == 'A') %>%
  filter(cope == TRUE) %>%
  summarise(count = n())

prominentCOPE
```

Count randomly selected journals listed as COPE members 
```{r}
randomCOPE <- dj_random %>%
  filter(ppc_type == 'A') %>%
  filter(cope == TRUE) %>%
  summarise(count = n())

randomCOPE
```

Prominent journals Web Of Science categories
```{r}
prominentCategory <- dj_prominent %>%
  filter(ppc_type == 'A') %>%
  group_by(field) %>%
  summarise(count = n()) %>%
  ungroup()

prominentCategory
```
Random journals Web Of Science categories
```{r}
randomCategory <- dj_random %>%
  filter(ppc_type == 'A') %>%
  group_by(field) %>%
  summarise(count = n()) %>%
  ungroup()

randomCategory
```
## How many journals offer post-publication critique?

Inspect how frequently PPC policies were stated for prominent journals 
```{r}
prominentPPC <- dj_prominent %>%
  filter(ppc_type == 'A') %>%
  group_by(has_ppc) %>%
  summarise(count = n()) %>%
  ungroup()

prominentPPC
```
Get the names of the prominent journals that have 'NO EXPLICIT' PPC options
```{r}
dj_prominent %>%
  filter(ppc_type == "A" & has_ppc == "NO EXPLICIT") %>%
  print()
```
Get names for prominent journals that offered more than one type of PPC
```{r}
# Return count
dj_prominent %>%
  filter((ppc_type == "B" | ppc_type == "C") & (!is.na(ppc_name))) %>%
  print()
```

Inspect PPC types at prominent journals
```{r}
table(dj_prominent$ppc_name)
```
Inspect the COPE status of prominent journals with and without PPC policies
```{r}
promCOPE <- dj_prominent %>%
 filter(ppc_type == "A") %>%
 mutate(has_ppc = case_when(
    has_ppc == "NO EXPLICIT" ~ "NO",
    has_ppc == "NO IMPLICIT" ~ "NO",
    TRUE ~ has_ppc
 )) %>%
 group_by(has_ppc) %>%
 summarise(
    total_count = n(),
    COPE_count = sum(cope == TRUE)
 ) %>%
 mutate(COPEpercentage = round((COPE_count / total_count) * 100)) %>%
 ungroup()

promCOPE
```

Inspect how frequently PPC policies were stated for randomly selected journals 
```{r}
randomPPC <- dj_random %>%
  filter(ppc_type == 'A') %>%
  group_by(has_ppc) %>%
  summarise(count = n()) %>%
  ungroup()

randomPPC
```
Get the names of the randomly selected journals that have 'NO EXPLICIT' PPC options
```{r}
dj_random %>%
  filter(ppc_type == "A" & has_ppc == "NO EXPLICIT") %>%
  print()
```

Calculate confidence interval for explicitly stated PPC policies among randomly selected journals
```{r}
randomPPCyes <- dj_random %>%
  filter(ppc_type == 'A', !is.na(ppc_name)) %>%
  summarise(count = n())

# Calculate Wilson confidence intervals
sample_size <- 100
confidence_level <- 0.95

#CIs for 'Yes Explicit'
randomPPC_CI <- binom.confint(randomPPCyes, sample_size, method = "wilson", conf.level = confidence_level)

randomPPC_CI
```
Get names for randomly selected journals that offered more than one type of PPC
```{r}
# Return all rows with ppc_name values for ppc_type B and C
dj_random %>%
  filter((ppc_type == "B" | ppc_type == "C") & (!is.na(ppc_name))) %>%
  print()
```

Get the names of the randomly selected journals that have 'NO EXPLICIT' PPC options
```{r}
dj_random %>%
  filter(ppc_type == "A" & has_ppc == "NO EXPLICIT") %>%
  print()
```

Inspect PPC types at randomly selected journals
```{r}
table(dj_random$ppc_name)
```

Inspect the COPE status of randomly selected journals with and without PPC policies
```{r}
randomCOPE <- dj_random %>%
 filter(ppc_type == "A") %>%
 mutate(has_ppc = case_when(
    has_ppc == "NO EXPLICIT" ~ "NO",
    has_ppc == "NO IMPLICIT" ~ "NO",
    TRUE ~ has_ppc
 )) %>%
 group_by(has_ppc) %>%
 summarise(
    total_count = n(),
    COPE_count = sum(cope == TRUE)
 ) %>%
 mutate(COPEpercentage = round((COPE_count / total_count) * 100)) %>%
 ungroup()

randomCOPE
```

# What limits did journals place on post-publication critique?

Find the most restrictive limits of any journal
```{r}
# Find the lowest length limit
minLength <- d_journals %>%
 select(c(sample_id, journal_name, ppc_name, ppc_length)) %>%
 filter(!is.na(ppc_name),
         ppc_length != "NOT STATED" & ppc_length != "Qualitative") %>%
 mutate(quantLength = as.numeric(ppc_length)) %>%
 slice_min(quantLength, n = 1) %>% # Select the row with the minimum quantLength
 ungroup()

minLength
```

``` {r}
# Find the lowest time-to-submit limit
minTime <- d_journals %>%
 select(c(sample_id, journal_name, ppc_name, ppc_time)) %>%
 filter(!is.na(ppc_name),
         ppc_time != "NOT STATED" & ppc_time != "Qualitative") %>%
 mutate(quantTime = as.numeric(ppc_time)) %>%
 slice_min(quantTime, n = 1) %>% # Select the row with the minimum quantTime
 ungroup()

minTime
```

## Calculations for Table 1: PPC limits in prominent journals

Check length limits placed on PPC options in prominent journals
```{r}
# Summarise length statistics for All Types
prominentLengthAll <- dj_prominent %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_length)) %>%
 mutate(quantLength = case_when(
    ppc_length == "NOT STATED" | ppc_length == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_length) # create a column that contains only quantitative limits
  )) %>%
 summarise(
    anyLimit = n() - sum(ppc_length == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_length == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianLength = median(quantLength, na.rm = TRUE),
    Q1 = quantile(quantLength, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantLength, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) 

prominentLengthAll
```

``` {r}
# Summarise length Statistics for each PPC type
prominentLengthType <- dj_prominent %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_length)) %>%
 mutate(quantLength = case_when(
    ppc_length == "NOT STATED" | ppc_length == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_length) # create a column that contains only quantitative limits
  )) %>%
 group_by(ppc_name) %>%
 summarise(
    anyLimit = n() - sum(ppc_length == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_length == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianLength = median(quantLength, na.rm = TRUE),
    Q1 = quantile(quantLength, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantLength, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) %>%
  ungroup()

prominentLengthType
```

Check time-to-submit limits placed on PPC options in prominent journals
```{r}
# Summarise time-to-submit statistics for All Types
prominentTimeAll <- dj_prominent %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_time)) %>%
 mutate(quantTime = case_when(
    ppc_time == "NOT STATED" | ppc_time == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_time) # create a column that contains only quantitative limits
  )) %>%
 summarise(
    anyLimit = n() - sum(ppc_time == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_time == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianTime = median(quantTime, na.rm = TRUE),
    Q1 = quantile(quantTime, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantTime, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) 

prominentTimeAll
```

``` {r}
# Summarise time-to-submit Statistics for each PPC type
prominentTimeType <- dj_prominent %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_time)) %>%
 mutate(quantTime = case_when(
    ppc_time == "NOT STATED" | ppc_time == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_time) # create a column that contains only quantitative limits
  )) %>%
  group_by(ppc_name) %>%
 summarise(
    anyLimit = n() - sum(ppc_time == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_time == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianTime = median(quantTime, na.rm = TRUE),
    Q1 = quantile(quantTime, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantTime, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) %>%
  ungroup()

prominentTimeType
```

Check reference limits placed on PPC options in prominent journals
```{r}
# Summarise reference statistics for All Types
prominentRefAll <- dj_prominent %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_ref)) %>%
 mutate(quantRef = case_when(
    ppc_ref == "NOT STATED" | ppc_ref == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_ref) # create a column that contains only quantitative limits
  )) %>%
 summarise(
    anyLimit = n() - sum(ppc_ref == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_ref == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianRef = median(quantRef, na.rm = TRUE),
    Q1 = quantile(quantRef, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantRef, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) 

prominentRefAll
```

```{r}
# Summarise reference statistics by type
prominentRefType <- dj_prominent %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_ref)) %>%
 mutate(quantRef = case_when(
    ppc_ref == "NOT STATED" | ppc_ref == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_ref) # create a column that contains only quantitative limits
  )) %>%
  group_by(ppc_name) %>%
 summarise(
    anyLimit = n() - sum(ppc_ref == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_ref == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianRef = median(quantRef, na.rm = TRUE),
    Q1 = quantile(quantRef, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantRef, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) %>%
  ungroup()

prominentRefType
```

Check how many PPC options are sent for external peer review in prominent journals
```{r}
# Peer review statistics for All Types
prominentReviewAll <- dj_prominent %>%
  select(c(journal_name, ppc_name, ppc_review)) %>%
  filter(!is.na(ppc_name)) %>%
  summarise(anyReview = n() - sum(ppc_review == "NOT STATED"),
            yesReview = anyReview - sum(ppc_review == "NO"),
            yesPercent = round((yesReview / n()) * 100)   # Percentage reviewed from All Types 
  )

prominentReviewAll

```

```{r}
# Peer review statistics by types
prominentReviewAll <- dj_prominent %>%
  select(c(journal_name, ppc_name, ppc_review)) %>%
  filter(!is.na(ppc_name)) %>%
  group_by(ppc_name) %>%
  summarise(anyReview = n() - sum(ppc_review == "NOT STATED"),
            yesReview = anyReview - sum(ppc_review == "NO"),
            yesPercent = round((yesReview / n()) * 100)
  ) %>%
  ungroup()

prominentReviewAll

```

## Calculations for Table 2: PPC limits in randomly selected journals

Check length limits placed on PPC options in randomly selected journals
```{r}
# Summarise length statistics for All Types
randomLengthAll <- dj_random %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_length)) %>%
 mutate(quantLength = case_when(
    ppc_length == "NOT STATED" | ppc_length == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_length) # create a column that contains only quantitative limits
  )) %>%
 summarise(
    anyLimit = n() - sum(ppc_length == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_length == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianLength = median(quantLength, na.rm = TRUE),
    Q1 = quantile(quantLength, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantLength, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) 

randomLengthAll
```

``` {r}
# Summarise length Statistics for each PPC type
randomLengthType <- dj_random %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_length)) %>%
 mutate(quantLength = case_when(
    ppc_length == "NOT STATED" | ppc_length == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_length) # create a column that contains only quantitative limits
  )) %>%
 group_by(ppc_name) %>%
 summarise(
    anyLimit = n() - sum(ppc_length == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_length == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianLength = median(quantLength, na.rm = TRUE),
    Q1 = quantile(quantLength, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantLength, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) %>%
  ungroup()

randomLengthType
```
Check time-to-submit limits placed on PPC options in prominent journals
```{r}
# Summarise time-to-submit statistics for All Types
randomTimeAll <- dj_random %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_time)) %>%
 mutate(quantTime = case_when(
    ppc_time == "NOT STATED" | ppc_time == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_time) # create a column that contains only quantitative limits
  )) %>%
 summarise(
    anyLimit = n() - sum(ppc_time == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_time == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianTime = median(quantTime, na.rm = TRUE),
    Q1 = quantile(quantTime, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantTime, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) 

randomTimeAll
```

``` {r}
# Summarise time-to-submit Statistics for each PPC type
randomTimeType <- dj_random %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_time)) %>%
 mutate(quantTime = case_when(
    ppc_time == "NOT STATED" | ppc_time == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_time) # create a column that contains only quantitative limits
  )) %>%
  group_by(ppc_name) %>%
 summarise(
    anyLimit = n() - sum(ppc_time == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_time == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianTime = median(quantTime, na.rm = TRUE),
    Q1 = quantile(quantTime, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantTime, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) %>%
  ungroup()

randomTimeType
```
Check reference limits placed on PPC options in prominent journals
```{r}
# Summarise reference statistics for All Types
randomRefAll <- dj_random %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_ref)) %>%
 mutate(quantRef = case_when(
    ppc_ref == "NOT STATED" | ppc_ref == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_ref) # create a column that contains only quantitative limits
  )) %>%
 summarise(
    anyLimit = n() - sum(ppc_ref == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_ref == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianRef = median(quantRef, na.rm = TRUE),
    Q1 = quantile(quantRef, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantRef, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) 

randomRefAll
```

```{r}
# Summarise reference statistics by type
randomRefType <- dj_random %>%
 filter(!is.na(ppc_name)) %>% 
 select(c(journal_name, ppc_name, ppc_ref)) %>%
 mutate(quantRef = case_when(
    ppc_ref == "NOT STATED" | ppc_ref == "Qualitative" ~ NA_real_,
    TRUE ~ as.numeric(ppc_ref) # create a column that contains only quantitative limits
  )) %>%
  group_by(ppc_name) %>%
 summarise(
    anyLimit = n() - sum(ppc_ref == "NOT STATED"),
    anyPercent = round((anyLimit / n()) * 100),
    quantLimit = anyLimit - sum(ppc_ref == "Qualitative"),
    quantPercent = round((quantLimit / n()) * 100),
    medianRef = median(quantRef, na.rm = TRUE),
    Q1 = quantile(quantRef, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(quantRef, probs = 0.75, na.rm = TRUE),
    IQR = Q3 - Q1 
 ) %>%
  ungroup()

randomRefType
```
Check how many PPC options are sent for external peer review in prominent journals
```{r}
# Peer review statistics for All Types
randomReviewAll <- dj_random %>%
  select(c(journal_name, ppc_name, ppc_review)) %>%
  filter(!is.na(ppc_name)) %>%
  summarise(anyReview = n() - sum(ppc_review == "NOT STATED"),
            yesReview = anyReview - sum(ppc_review == "NO"),
            yesPercent = round((yesReview / n()) * 100)   # Percentage reviewed from All Types 
  )

randomReviewAll

```

```{r}
# Peer review statistics by types
randomReviewAll <- dj_random %>%
  select(c(journal_name, ppc_name, ppc_review)) %>%
  filter(!is.na(ppc_name)) %>%
  group_by(ppc_name) %>%
  summarise(anyReview = n() - sum(ppc_review == "NOT STATED"),
            yesReview = anyReview - sum(ppc_review == "NO"),
            yesPercent = round((yesReview / n()) * 100)
  ) %>%
  ungroup()

randomReviewAll
```
# STUDY 2: PREVALENCE 

Look for links to PPC in articles published in prominent journals
```{r}
d_articles %>%
  filter(sample_id == "prominent",
         ppc_linked == TRUE) %>%
  summarise(n = n())
```

Calculate CIs for Linked PPC 
```{r}
sample_size_a <- 101

# Linked PPCs
prominent_linked <- d_articles %>% # counts number of linked PPC events
  filter(sample_id == "prominent",
         ppc_linked == TRUE) %>%
  count()

ci_linked <- binom.confint(prominent_linked$n, sample_size_a, method = "wilson", conf.level = confidence_level)

# Convert the lower and upper limits to percentages and round them to one decimal place
ci_promLinked_LL <- round(ci_linked$lower*100, 1)
ci_promLinked_UL <- round(ci_linked$upper*100, 1)

ci_promLinked_LL
ci_promLinked_UL
```

Look for instances of PPC in articles published in prominent journals
```{r}
d_articles %>%
  filter(sample_id == "prominent",
         exclude_reason == "IS ITSELF PPC") %>%
  summarise(n = n())
```
Calculate CIs for Instance PPC in prominent journals
```{r}
# Instance PPCs
prominent_instance <- d_articles %>% # counts number of linked PPC events
  filter(sample_id == "prominent",
    exclude_reason == "IS ITSELF PPC") %>%
  count()

ci_instance <- binom.confint(prominent_instance$n, sample_size_a, method = "wilson", conf.level = confidence_level)

# Convert the lower and upper limits to percentages and round them to one decimal place
ci_promInstance_LL <- round(ci_instance$lower*100, 1)
ci_promIinstance_UL <- round(ci_instance$upper*100, 1)

ci_promInstance_LL
ci_promIinstance_UL
```
Look for linked PPC in articles in random sample
```{r}
d_articles %>%
  filter(sample_id == "random",
         ppc_linked == TRUE) %>%
  summarise(n = n())
```

Calculate CIs for linked PPC in articles in random sample
```{r}
# Linked PPCs
random_linked <- d_articles %>% # counts number of linked PPC events
  filter(sample_id == "random",
         ppc_linked == TRUE) %>%
  count()

ci_Rlinked <- binom.confint(random_linked$n, sample_size_a, method = "wilson", conf.level = confidence_level)

# Convert the lower and upper limits to percentages and round them to one decimal place
ci_randLinked_LL <- round(ci_Rlinked$lower*100, 1)
ci_randLinked_UL <- round(ci_Rlinked$upper*100, 1)

ci_randLinked_LL
ci_randLinked_UL
```
Look for instances of PPC in articles in random sample
```{r}
d_articles %>%
  filter(sample_id == "random",
         exclude_reason == "IS ITSELF PPC") %>%
  summarise(n = n())
```

Calculate CIs for Instance PPC in random sample
```{r}
# Instance PPCs
random_instance <- d_articles %>% # counts number of linked PPC events
  filter(sample_id == "random",
    exclude_reason == "IS ITSELF PPC") %>%
  count()

ci_Rinstance <- binom.confint(random_instance$n, sample_size_a, method = "wilson", conf.level = confidence_level)

# Convert the lower and upper limits to percentages and round them to one decimal place
ci_randInstance_LL <- round(ci_Rinstance$lower*100, 1)
ci_randIinstance_UL <- round(ci_Rinstance$upper*100, 1)

ci_randInstance_LL
ci_randIinstance_UL
```

# FIGURES
Boxplot of quantitative length limits
```{r}
quantLength <- d_journals %>%
 select(c(sample_id, ppc_name, ppc_length)) %>%
 filter(!is.na(ppc_length),
         ppc_length != "NOT STATED",
         ppc_length != "Qualitative") %>%
 mutate(Length = as.numeric(ppc_length))

quantLength %>%  
 ggplot(mapping = aes(x = ppc_name, y = Length, colour = sample_id)) +
 geom_violin(
    color = "black",
    fill = "lightblue",
    alpha = 0.5
 ) +
 geom_jitter(width = 0.1,
             alpha = 0.8) + 
 scale_fill_brewer(palette = "Set2") +
 scale_color_brewer(palette = "Set2") +
 coord_flip() +
 theme_bw() +
 labs(title = "All stated quantitative length Limits", x = "Post-publication critique type", y = "Length limits (words)")

```
Boxplot of quantitative time limits
```{r}
quantTime <- d_journals %>%
 select(c(sample_id, ppc_name, ppc_time)) %>%
 filter(!is.na(ppc_time),
         ppc_time != "NOT STATED",
         ppc_time != "Qualitative") %>%
 mutate(Time = as.numeric(ppc_time))

quantTime %>%  
 ggplot(mapping = aes(x = ppc_name, y = Time, colour = sample_id)) +
 geom_boxplot(
    color = "black",
    fill = "lightblue",
    alpha = 0.5
 ) +
 geom_jitter(width = 0.2) + 
 scale_fill_brewer(palette = "Set2") +
 scale_color_brewer(palette = "Set2") +
 coord_flip() +
 theme_bw() +
 labs(title = "All stated quantitative time limits", x = "Post-publication critique type", y = "Time limits (weeks)")
```
### *Post-Publication Critique Policy and Restriction Statements in Prominent Psychology Journals*

```{r, echo = FALSE, message=FALSE}
# Filter and transform restrictions for ppc_length
prominent_length_data <- dj_prominent %>%
  filter(!is.na(ppc_name)) %>%
  filter(has_ppc != "ARCHIVE") %>% # removes 'Archive Only' PPC types
  mutate(ppc_length = case_when(
    ppc_length %in% c(1000, 1100, 1200, 1500, 2000, 2500, 2650, 3000, 3500, 400, 500, 5000, 750, 800, 8000) ~ 'Quantitative',
    ppc_length == "NOT STATED" ~ "Not Stated",
    TRUE ~ 'Qualitative' # Summarises all length limits as 'Quantitative', 'Qualitative', or 'Not Stated'
  )) %>% 
  group_by(ppc_length) %>%
  summarise(count = n())

# Filter and transform restrictions for ppc_time
prominent_time_data <- dj_prominent %>%
  filter(!is.na(ppc_name)) %>%
  filter(has_ppc != "ARCHIVE") %>% # removes 'Archive Only' PPC types
  mutate(ppc_time = case_when(
    ppc_time %in% c(13.05, 26.1, 39.15, 4, 52) ~ 'Quantitative',
    ppc_time == "NOT STATED" ~ "Not Stated",
    TRUE ~ 'Qualitative' # Summarises all time limits as 'Quantitative', 'Qualitative', or 'Not Stated'
  )) %>%
  group_by(ppc_time) %>%
  summarise(count = n())

# Combine the data and unite the columns
combined_data <- bind_rows(
  prominent_length_data %>% mutate(Code = "Length"),
  prominent_time_data %>% mutate(Code = "Time-to-submit")
) %>%
unite(limits, ppc_length, ppc_time) %>%
  mutate(limits = case_when(limits == "Not Stated_NA" ~ "Not Stated",
                   limits == "Qualitative_NA" ~ "Qualitative",
                   limits == "Quantitative_NA" ~ "Quantitative",
                   limits == "NA_Not Stated" ~ "Not Stated",
                   limits == "NA_Qualitative" ~ "Qualitative",
                   limits == "NA_Quantitative" ~ "Quantitative",
                   TRUE ~ as.character(limits)
                   ))

# Create the first graph
graph1 <- ggplot(combined_data, aes(x = Code, y = count, fill = limits)) +
  geom_bar(stat = "identity", 
           position = "stack",
           colour = "black") +
  theme_bw() +
  scale_fill_brewer(palette = "Blues") +
  labs(x = "Restriction Type", y = "Count", fill = "Restrictions") +
  theme(axis.text.x = element_text(size = 7))

# Create the second graph
graph2 <- dj_prominent %>%
  filter(ppc_type == "A") %>% # Keeps only first entry for each journal
  filter(!is.na(has_ppc)) %>% # Remove journal rows with no (NA) PPC options 
  mutate(has_ppc = case_when(
    has_ppc == 'ARCHIVE' ~ 'Yes Implicit',
    has_ppc == 'NO EXPLICIT' ~ 'No Explicit',
    has_ppc == 'NO IMPLICIT' ~ 'No Implicit',
    has_ppc == 'YES' ~ 'Yes Explicit',
    TRUE ~ has_ppc
  )) %>%
  group_by(has_ppc) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = "", y = count, fill = has_ppc)) +
  geom_bar(stat = "identity",
           colour = "black",
           width = 0.8) +
  theme_bw() +
  scale_fill_brewer(palette = "YlOrRd", direction = -1) +
  labs(x = "Journal Policy", y = "Count", fill = "Accepts PPC")

# Arrange both graphs in the same figure
combined_plots <- graph2 + graph1
combined_plots

#ggsave("ProminentJournalPolicies.png", plot = last_plot(), device = "png")
```

### *Post-Publication Critique Policy and Restriction Statements in Randomly-selected Psychology Journals*
```{r echo=FALSE, message=FALSE}
# Create and combine restriction statement graphs with PPC acceptance (random sample)

# Filter and process data for ppc_length
random_length_data <- d_journals %>%
  filter(sample_id %in% c("random", "both")) %>%
  filter(!is.na(ppc_name)) %>%
  filter(has_ppc != "ARCHIVE") %>%
  mutate(ppc_length = case_when(
    ppc_length %in% c(1000, 1100, 1200, 1500, 2000, 2500, 2650, 3000, 3500, 400, 500, 5000, 750, 800, 8000) ~ 'Quantitative',
    ppc_length == "NOT STATED" ~ "Not Stated",
    TRUE ~ 'Qualitative'
  )) %>%
  group_by(ppc_length) %>%
  summarise(count = n())

# Filter and process data for ppc_time
random_time_data <- d_journals %>%
  filter(sample_id %in% c("random", "both")) %>%
  filter(!is.na(ppc_name)) %>%
  filter(has_ppc != "ARCHIVE") %>%
  mutate(ppc_time = case_when(
    ppc_time %in% c(13.05, 26.1, 39.15, 4, 52) ~ 'Quantitative',
    ppc_time == "NOT STATED" ~ "Not Stated",
    TRUE ~ 'Qualitative'
  )) %>%
  group_by(ppc_time) %>%
  summarise(count = n())

# Combine the data and unite the columns
combined_data_random <- bind_rows(
  random_length_data %>% mutate(Code = "Length"),
  random_time_data %>% mutate(Code = "Time-to-submit")
) %>%
unite(limits, ppc_length, ppc_time) %>%
  mutate(limits = case_when(limits == "Not Stated_NA" ~ "Not Stated",
                   limits == "Qualitative_NA" ~ "Qualitative",
                   limits == "Quantitative_NA" ~ "Quantitative",
                   limits == "NA_Not Stated" ~ "Not Stated",
                   limits == "NA_Qualitative" ~ "Qualitative",
                   limits == "NA_Quantitative" ~ "Quantitative",
                   TRUE ~ as.character(limits)
                   ))

# Create the first graph
graph4 <- ggplot(combined_data_random, aes(x = Code, y = count, fill = limits)) +
  geom_bar(stat = "identity", 
           position = "stack",
           colour = "black") +
  theme_bw() +
  scale_fill_brewer(palette = "Blues") +
  labs(x = "Restriction Type", y = "Count", fill = "Restrictions") +
  theme(axis.text.x = element_text(size = 7))

# Create the second graph
graph3 <- d_journals %>%
  filter(sample_id == "random" | sample_id == "both") %>%
  filter(ppc_type == "A") %>%
  filter(!is.na(has_ppc)) %>%
  mutate(has_ppc = case_when(
    has_ppc == 'ARCHIVE' ~ 'Yes Implicit',
    has_ppc == 'NO EXPLICIT' ~ 'No Explicit',
    has_ppc == 'NO IMPLICIT' ~ 'No Implicit',
    has_ppc == 'YES' ~ 'Yes Explicit',
    TRUE ~ has_ppc
  )) %>%
  group_by(has_ppc) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ggplot(aes(x = "", y = count, fill = has_ppc)) +
  geom_bar(stat = "identity",
           colour = "black",
           width = 0.8) +
  theme_bw() +
  scale_fill_brewer(palette = "YlOrRd", direction = -1) +
  labs(x = "Journal Policy", y = "Count", fill = "Accepts PPC")

# Arrange both graphs in the same figure
combined_plots <- graph3 + graph4
combined_plots

#ggsave("RandomJournalPolicies.png", plot = last_plot(), device = "png")
```
